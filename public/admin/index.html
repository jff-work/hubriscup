<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hubris Cup â€“ Admin</title>
  <link rel="stylesheet" href="/assets/css/style.css">
  <style>
    /* Hide number input arrows completely */
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
      appearance: textfield;
    }
    
    /* Hide steppers only on result inputs */
    .result-input[type="number"] {
      appearance: textfield;        /* modern + Firefox */
      -moz-appearance: textfield;   /* Firefox */
    }

    /* Chrome / Edge / Safari / Opera */
    .result-input[type="number"]::-webkit-inner-spin-button,
    .result-input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    /* Popup overlay styles */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .popup-content {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      min-width: 400px;
      max-width: 600px;
      max-height: 80vh;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    
    .popup-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
    }
    
    .popup-header h3 {
      margin: 0;
      color: var(--ink);
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      color: var(--ink);
      cursor: pointer;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .close-btn:hover {
      background: var(--border);
      border-radius: 4px;
    }
    
    .popup-body {
      padding: 20px;
    }
    
    .popup-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      padding: 15px 20px;
      border-top: 1px solid var(--border);
    }
    
    /* Debug toggle styles */
    .topbar {
      position: relative;
    }
    
    .debug-toggle {
      position: absolute;
      top: 50%;
      right: 20px;
      transform: translateY(-50%);
      z-index: 100;
    }
    
    .debug-btn {
      background: var(--border);
      border: 1px solid var(--accent);
      color: var(--ink);
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: bold;
      transition: all 0.2s ease;
    }
    
    .debug-btn:hover {
      background: var(--accent);
      color: var(--card);
    }
    
    .debug-btn.active {
      background: var(--accent);
      color: var(--card);
      box-shadow: 0 0 5px rgba(255, 165, 0, 0.5);
    }
    
    /* Hidden debug elements */
    .debug-hidden {
      display: none !important;
    }
  </style>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="/assets/js/i18n.js"></script>
</head>
<body class="admin">
  <div class="topbar">
    <div class="container header">
      <div class="flex">
        <span class="badge">Admin</span>
      </div>
      <div class="flex">
        <button class="ghost debug-hidden" id="newEventBtn"><span data-i18n="newEvent"></span></button>
        <label class="lang-toggle small">
          <span data-i18n="locale"></span>:
          <select id="langSel">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
          </select>
        </label>
      </div>
      <div class="debug-toggle">
        <button class="debug-btn" id="debugToggleBtn">DEBUG</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Preparation Stage -->
    <div id="preparationStage" class="card" style="display:none">
      <div class="flex"><strong data-i18n="players"></strong><span class="right small">Status: <span id="status"></span></span></div>
      <div class="legend" id="legendNoPhoneAdmin" data-i18n="noPhoneExplain"></div>
      <div class="stack" style="margin-top:10px">
        <div class="flex">
          <input id="newPlayer" placeholder="Name">
          <button id="addBtn"><span data-i18n="addPlayer"></span></button>
        </div>
        <div class="center" style="margin-top:15px">
          <button id="importPlayersBtn" class="secondary">Import Players</button>
        </div>
        <ul id="playersList" class="list"></ul>
        <div class="center" style="margin-top:15px">
          <button id="startBtn" class="btn"><span data-i18n="startCheckin"></span></button>
        </div>
      </div>
    </div>

    <!-- Check-in Stage -->
    <div id="checkinStage" class="card" style="display:none">
      <div class="flex"><strong data-i18n="players"></strong><span class="right small">Status: <span id="status2"></span></span></div>
      <div class="legend" id="legendNoPhoneAdmin2" data-i18n="noPhoneExplain"></div>
      <div class="stack" style="margin-top:10px">
        <div class="flex">
          <input id="newPlayer2" placeholder="Name">
          <button id="addBtn2"><span data-i18n="addPlayer"></span></button>
        </div>
        <ul id="playersList2" class="list"></ul>
        <div class="center" style="margin-top:15px">
          <button id="podsBtn" class="btn"><span data-i18n="createPods"></span></button>
        </div>
      </div>
    </div>

    <!-- Pods Stage -->
    <div id="podsStage" class="card" style="display:none">
      <div class="flex"><strong>Pods</strong></div>
      <div id="draftVisuals" class="stack" style="margin-top:15px"></div>
      <div id="podsArea" class="stack" style="margin-top:15px"></div>
      <div class="center" style="margin-top:15px">
        <button id="r1Btn" class="btn"><span data-i18n="createR1"></span></button>
      </div>
    </div>

    <!-- Rounds Stage -->
    <div class="card" id="pairingsCard" style="display:none">
      <!-- Tab navigation -->
      <div class="tab-nav" style="margin-top:0; margin-bottom:15px;">
        <div class="tab-btn round-tab" style="background:var(--card); color:var(--ink); cursor:default; border-bottom:2px solid var(--accent);">
          <strong><span id="roundNo">-</span></strong>
        </div>
        <button class="tab-btn active" data-tab="pairings">Pairings</button>
        <button class="tab-btn" data-tab="standings">Standings</button>
      </div>
      
      <!-- Pairings Tab Content -->
      <div id="pairingsTab" class="tab-content active">
        <div style="overflow:auto; margin-top:15px">
          <table class="table" id="pairingsTbl">
            <thead>
              <tr>
                <th data-i18n="table"></th>
                <th>Player 1</th>
                <th>Score 1</th>
                <th>VS</th>
                <th>Player 2</th>
                <th>Score 2</th>
                <th>Draws</th>
                <th>Save</th>
                <th>Confirmed</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <div class="center" style="margin-top:15px">
          <button id="nextRoundBtn" class="btn"><span data-i18n="createNextRound"></span></button>
          <button id="finalizeBtn" class="btn"><span data-i18n="finalize"></span></button>
        </div>
      </div>
      
      <!-- Standings Tab Content -->
      <div id="standingsTab" class="tab-content">
        <div style="overflow:auto; margin-top:15px">
          <table class="table" id="adminRoundStandingsTbl">
            <thead>
              <tr>
                <th>#</th>
                <th data-i18n="players"></th>
                <th data-i18n="points"></th>
                <th data-i18n="omw"></th>
                <th data-i18n="gwp"></th>
                <th data-i18n="ogw"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Standings Stage -->
    <div class="card" id="standingsCard" style="display:none">
      <div class="flex"><strong data-i18n="standings"></strong></div>
      <div style="overflow:auto">
        <table class="table" id="standingsTbl">
          <thead>
            <tr>
              <th>#</th>
              <th data-i18n="players"></th>
              <th data-i18n="points"></th>
              <th data-i18n="omw"></th>
              <th data-i18n="gwp"></th>
              <th data-i18n="ogw"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Final Standings Stage (Tournament Complete) -->
    <div class="card" id="finalStandingsCard" style="display:none">
      <div class="flex"><strong>Final Standings</strong></div>
      <div style="overflow:auto">
        <table class="table" id="finalStandingsTbl">
          <thead>
            <tr>
              <th>#</th>
              <th data-i18n="players"></th>
              <th data-i18n="points"></th>
              <th data-i18n="omw"></th>
              <th data-i18n="gwp"></th>
              <th data-i18n="ogw"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <!-- Top 8 Creation Stage -->
    <div class="card" id="top8CreationCard" style="display:none">
      <div class="flex"><strong>Create Top 8</strong></div>
      <div class="center" style="margin-top:15px">
        <button id="createTop8Btn" class="btn"><span data-i18n="createTop8"></span></button>
      </div>
    </div>

    <!-- Top 8 Draft Stage -->
    <div class="card" id="top8DraftCard" style="display:none">
      <div class="flex"><strong>Top 8 Draft</strong></div>
      <div id="top8DraftVisuals" class="stack" style="margin-top:15px"></div>
      <div class="center" style="margin-top:15px">
        <button id="startTop8Btn" class="btn"><span data-i18n="startTop8"></span></button>
      </div>
    </div>

    <div class="card debug-hidden" id="debugCard">
      <div class="flex"><strong data-i18n="debug"></strong></div>
      <div class="grid three">
        <div class="stack">
          <div class="small" data-i18n="populate"></div>
          <div class="flex">
            <input type="number" id="dbgCount" min="1" max="64" value="16" style="width:120px">
            <button id="dbgPopulate">Go</button>
          </div>
        </div>
        <div class="stack">
          <div class="small" data-i18n="checkinAll"></div>
          <button id="dbgCheckin">Go</button>
        </div>
        <div class="stack">
          <div class="small" data-i18n="randomize"></div>
          <button id="dbgRandom">Go</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Import Players Popup -->
  <div id="importPopup" class="popup-overlay" style="display:none;">
    <div class="popup-content">
      <div class="popup-header">
        <h3>Import Players</h3>
        <button id="closeImportPopup" class="close-btn">&times;</button>
      </div>
      <div class="popup-body">
        <div class="small" style="margin-bottom:10px;">Enter player names (one per line):</div>
        <textarea id="importPlayersText" placeholder="Player 1&#10;Player 2&#10;Player 3..." style="width:100%; min-height:200px; background:#0f1318; border:1px solid #1f2a38; color:#e7edf4; padding:8px; border-radius:4px; font-family:inherit; resize:vertical;"></textarea>
      </div>
      <div class="popup-footer">
        <button id="cancelImport" class="ghost">Cancel</button>
        <button id="confirmImport" class="btn">Import Players</button>
      </div>
    </div>
  </div>

<script>
function applyI18N(){
  $('[data-i18n]').each(function(){ const k=$(this).data('i18n'); $(this).text(I18N.t(k)); });
  $('#langSel').val(I18N.lang);
}

function getRoundLabel(round) {
  if (round == 100) return I18N.t('qf');
  if (round == 101) return I18N.t('sf');
  if (round == 102) return I18N.t('f');
  return 'Round ' + round;
}
$('#langSel').on('change', function(){ I18N.setLang(this.value); applyI18N(); });
document.addEventListener('langchange', applyI18N); applyI18N();

function initTabs(){
  $('.tab-btn').off('click').on('click', function(){
    const tabName = $(this).data('tab');
    
    // Remove active class from all tabs and content
    $('.tab-btn').removeClass('active');
    $('.tab-content').removeClass('active');
    
    // Add active class to clicked tab and corresponding content
    $(this).addClass('active');
    $('#' + tabName + 'Tab').addClass('active');
  });
}

function renderAdminRoundStandings(stand){
  const tb = $('#adminRoundStandingsTbl tbody'); tb.empty();
  (stand || []).forEach((r,idx)=>{
    const tr = $('<tr/>');
    tr.append($('<td/>').text(idx+1));
    tr.append($('<td/>').text(r.name));
    tr.append($('<td/>').text(r.mp));
    tr.append($('<td/>').text(r.omw.toFixed(3)));
    tr.append($('<td/>').text(r.gwp.toFixed(3)));
    tr.append($('<td/>').text(r.ogw.toFixed(3)));
    tb.append(tr);
  });
}

const api = (a, data) => $.ajax({url:'/api/api.php?a='+encodeURIComponent(a), method:'POST', data:data||{}, dataType:'json'});

function ping(){ /* ping functionality removed */ }

let lastState = null;
let focusedInputInfo = null;

function load(){
  ping();
  api('get_state', {view:'admin'}).done(function(data) {
    // Check if user is currently editing a result input
    const focusedInput = document.activeElement;
    const isEditingResult = focusedInput && focusedInput.classList.contains('result-input');
    
    // Store info about the focused input if it's a result input
    if (isEditingResult) {
      const matchId = $(focusedInput).closest('tr').data('match-id');
      const inputType = $(focusedInput).index(); // 0=p1, 1=p2, 2=draws
      const currentValue = focusedInput.value;
      const cursorPosition = focusedInput.selectionStart;
      
      focusedInputInfo = {
        matchId: matchId,
        inputType: inputType,
        value: currentValue,
        cursorPosition: cursorPosition,
        element: focusedInput
      };
    } else {
      focusedInputInfo = null;
    }
    
    // Check if state has actually changed
    const stateChanged = !lastState || JSON.stringify(data) !== JSON.stringify(lastState);
    
    if (stateChanged) {
      lastState = data;
      render(data);
    }
  });
}


function render(res){
  $('#status').text(res.settings.status);
  $('#status2').text(res.settings.status);
  const status = res.settings.status;
  const players = res.players||[];

  function show(id, on){ $(id).toggle(!!on); }

  // Players - handle both preparation and check-in stages
  const ul = $('#playersList').empty();
  const ul2 = $('#playersList2').empty();
  players.forEach(p=>{
    const li = $('<li/>');
    const left = $('<div/>').text(p.name + (p.pod? ('  (Pod '+p.pod+' S'+p.pod_seat+')') : ''));
    const right = $('<div class="flex"/>');
    right.append($('<span/>').addClass('badge '+(p.no_phone?'orange':(p.checked_in?'green':''))).text(p.no_phone?I18N.t('noPhone'):(p.checked_in?I18N.t('checkedIn'):I18N.t('notCheckedIn'))));
    const del = $('<button class="ghost small-btn"/>').text(I18N.t('remove')).on('click',()=> api('remove_player', {id:p.id}).done(load));
    right.append(del);
    if(status==='checkin' && !p.checked_in){
      const np = $('<button class="ghost small-btn"/>').text('no-phone manual checkin').on('click',()=> api('admin_checkin_no_phone',{player_id:p.id}).done(load));
      right.append(np);
    }
    li.append(left).append(right);
    ul.append(li.clone());
    ul2.append(li);
  });

  // Controls
  $('#startBtn').off('click').on('click',()=> api('start_event', {}).done(load));
  $('#addBtn').off('click').on('click',()=>{
    const name = $('#newPlayer').val().trim(); if(!name) return;
    api('add_player',{name}).done(()=>{$('#newPlayer').val(''); load();});
  });
  // Import popup functionality
  $('#importPlayersBtn').off('click').on('click',()=>{
    // Load zugesagt.json content and pre-fill the textarea
    api('get_zugesagt', {}).done(function(response) {
      if(response.ok && response.players && Array.isArray(response.players)) {
        $('#importPlayersText').val(response.players.join('\n'));
      } else {
        $('#importPlayersText').val('');
      }
    }).fail(function() {
      // If zugesagt.json doesn't exist or fails to load, start with empty textarea
      $('#importPlayersText').val('');
    });
    $('#importPopup').show();
  });
  
  $('#closeImportPopup, #cancelImport').off('click').on('click',()=>{
    $('#importPopup').hide();
  });
  
  $('#confirmImport').off('click').on('click',()=>{
    const playersText = $('#importPlayersText').val().trim();
    if(!playersText) {
      $('#importPopup').hide();
      return;
    }
    
    // Split by line breaks and filter out empty strings
    const players = playersText.split('\n').filter(name => name.trim() !== '');
    if(players.length === 0) {
      $('#importPopup').hide();
      return;
    }
    
    // Import all players
    let completed = 0;
    players.forEach(playerName => {
      api('add_player', {name: playerName.trim()}).done(() => {
        completed++;
        if(completed === players.length) {
          $('#importPopup').hide();
          load();
        }
      });
    });
  });
  $('#addBtn2').off('click').on('click',()=>{
    const name = $('#newPlayer2').val().trim(); if(!name) return;
    api('add_player',{name}).done(()=>{$('#newPlayer2').val(''); load();});
  });
  $('#newEventBtn').off('click').on('click',()=>{
    if(confirm(I18N.t('confirmNewEvent'))) {
      api('new_event', {}).done(load);
    }
  });

  // Pods
  $('#podsBtn').off('click').on('click',()=>{
    if(players.some(p=>!p.checked_in)){
      if(!confirm(I18N.t('warningUnchecked'))) return;
      api('create_pods',{force:1}).done(load);
    } else {
      api('create_pods',{}).done(load);
    }
  });
  $('#r1Btn').off('click').on('click',()=> api('create_r1',{}).done(load));

  // Draft visuals
  const draftVisuals = $('#draftVisuals').empty();
  (res.pods||[]).forEach(pod=>{
    const podCard = $('<div class="card"/>');
    podCard.append($('<div/>').html('<strong>Pod '+pod.pod+'</strong> ('+pod.seats.length+')'));
    
    const vis = $('<div/>').addClass('draft-table');
    
    // Create seat map for easy lookup
    const seatMap = {};
    pod.seats.forEach(s => { seatMap[s.seat] = s; });
    
    const playerCount = pod.seats.length;
    
    if (playerCount === 6) {
      // For 6 players: 3 seats on top, 3 seats on bottom
      const topRow = $('<div/>').addClass('draft-row');
      const bottomRow = $('<div/>').addClass('draft-row');
      
      // Top row: 1, 2, 3
      [1, 2, 3].forEach(seatNum => {
        const seat = seatMap[seatNum];
        const seatDiv = $('<div/>').addClass('seat');
        seatDiv.append($('<span/>').addClass('pos').text('S'+seatNum));
        seatDiv.append($('<span/>').addClass('name').text(seat ? seat.name : ''));
        topRow.append(seatDiv);
      });
      
      // Bottom row: 6, 5, 4 (reverse order)
      [6, 5, 4].forEach(seatNum => {
        const seat = seatMap[seatNum];
        const seatDiv = $('<div/>').addClass('seat');
        seatDiv.append($('<span/>').addClass('pos').text('S'+seatNum));
        seatDiv.append($('<span/>').addClass('name').text(seat ? seat.name : ''));
        bottomRow.append(seatDiv);
      });
      
      vis.append(topRow);
      vis.append(bottomRow);
    } else if (playerCount === 7) {
      // For 7 players: show only occupied seats but maintain 8-seat positioning
      const topRow = $('<div/>').addClass('draft-row');
      const bottomRow = $('<div/>').addClass('draft-row');
      
      // Top row: 1, 2, 3, 4 - only show occupied seats
      [1, 2, 3, 4].forEach(seatNum => {
        const seat = seatMap[seatNum];
        if(seat){
          const seatDiv = $('<div/>').addClass('seat');
          seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
          seatDiv.append($('<span/>').addClass('name').text(seat.name));
          topRow.append(seatDiv);
        } else {
          // Add invisible placeholder to maintain positioning
          const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
          topRow.append(placeholder);
        }
      });
      
      // Bottom row: 8, 7, 6, 5 (reverse order) - only show occupied seats
      [8, 7, 6, 5].forEach(seatNum => {
        const seat = seatMap[seatNum];
        if(seat){
          const seatDiv = $('<div/>').addClass('seat');
          seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
          seatDiv.append($('<span/>').addClass('name').text(seat.name));
          bottomRow.append(seatDiv);
        } else {
          // Add invisible placeholder to maintain positioning
          const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
          bottomRow.append(placeholder);
        }
      });
      
      vis.append(topRow);
      vis.append(bottomRow);
    } else if (playerCount === 8) {
      // For 8 players: show all 8 seats
      const topRow = $('<div/>').addClass('draft-row');
      const bottomRow = $('<div/>').addClass('draft-row');
      
      // Top row: 1, 2, 3, 4
      [1, 2, 3, 4].forEach(seatNum => {
        const seat = seatMap[seatNum];
        const seatDiv = $('<div/>').addClass('seat');
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        topRow.append(seatDiv);
      });
      
      // Bottom row: 8, 7, 6, 5 (reverse order)
      [8, 7, 6, 5].forEach(seatNum => {
        const seat = seatMap[seatNum];
        const seatDiv = $('<div/>').addClass('seat');
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        bottomRow.append(seatDiv);
      });
      
      vis.append(topRow);
      vis.append(bottomRow);
    } else if (playerCount === 9) {
      // For 9 players: show only occupied seats but maintain 10-seat positioning
      const topRow = $('<div/>').addClass('draft-row');
      const bottomRow = $('<div/>').addClass('draft-row');
      
      // Top row: 1, 2, 3, 4, 5 - only show occupied seats
      [1, 2, 3, 4, 5].forEach(seatNum => {
        const seat = seatMap[seatNum];
        if(seat){
          const seatDiv = $('<div/>').addClass('seat');
          seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
          seatDiv.append($('<span/>').addClass('name').text(seat.name));
          topRow.append(seatDiv);
        } else {
          // Add invisible placeholder to maintain positioning
          const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
          topRow.append(placeholder);
        }
      });
      
      // Bottom row: 10, 9, 8, 7, 6 (reverse order) - only show occupied seats
      [10, 9, 8, 7, 6].forEach(seatNum => {
        const seat = seatMap[seatNum];
        if(seat){
          const seatDiv = $('<div/>').addClass('seat');
          seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
          seatDiv.append($('<span/>').addClass('name').text(seat.name));
          bottomRow.append(seatDiv);
        } else {
          // Add invisible placeholder to maintain positioning
          const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
          bottomRow.append(placeholder);
        }
      });
      
      vis.append(topRow);
      vis.append(bottomRow);
    } else if (playerCount === 10) {
      // For 10 players: show all 10 seats
      const topRow = $('<div/>').addClass('draft-row');
      const bottomRow = $('<div/>').addClass('draft-row');
      
      // Top row: 1, 2, 3, 4, 5
      [1, 2, 3, 4, 5].forEach(seatNum => {
        const seat = seatMap[seatNum];
        const seatDiv = $('<div/>').addClass('seat');
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        topRow.append(seatDiv);
      });
      
      // Bottom row: 10, 9, 8, 7, 6 (reverse order)
      [10, 9, 8, 7, 6].forEach(seatNum => {
        const seat = seatMap[seatNum];
        const seatDiv = $('<div/>').addClass('seat');
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        bottomRow.append(seatDiv);
      });
      
      vis.append(topRow);
      vis.append(bottomRow);
    } else {
      // For other player counts: show only occupied seats but maintain appropriate positioning for odd counts
      const topRow = $('<div/>').addClass('draft-row');
      const bottomRow = $('<div/>').addClass('draft-row');
      
      // Determine if we need to maintain positioning (for odd player counts)
      const isOddCount = playerCount % 2 === 1;
      const maxSeats = Math.max(...pod.seats.map(s => s.seat));
      
      // For odd counts, determine the appropriate layout based on max seats
      const useTenSeatLayout = isOddCount && maxSeats > 8;
      const topSeats = useTenSeatLayout ? [1, 2, 3, 4, 5] : [1, 2, 3, 4];
      const bottomSeats = useTenSeatLayout ? [10, 9, 8, 7, 6] : [8, 7, 6, 5];
      
      // Top row: show occupied or placeholder for odd counts
      topSeats.forEach(seatNum => {
        const seat = seatMap[seatNum];
        if (seat) {
          const seatDiv = $('<div/>').addClass('seat');
          seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
          seatDiv.append($('<span/>').addClass('name').text(seat.name));
          topRow.append(seatDiv);
        } else if (isOddCount && seatNum <= maxSeats) {
          // Add invisible placeholder to maintain positioning for odd counts
          const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
          topRow.append(placeholder);
        }
      });
      
      // Bottom row: show occupied or placeholder for odd counts
      bottomSeats.forEach(seatNum => {
        const seat = seatMap[seatNum];
        if (seat) {
          const seatDiv = $('<div/>').addClass('seat');
          seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
          seatDiv.append($('<span/>').addClass('name').text(seat.name));
          bottomRow.append(seatDiv);
        } else if (isOddCount && seatNum <= maxSeats) {
          // Add invisible placeholder to maintain positioning for odd counts
          const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
          bottomRow.append(placeholder);
        }
      });
      
      vis.append(topRow);
      vis.append(bottomRow);
    }
    
    podCard.append(vis);
    draftVisuals.append(podCard);
  });

  const podsArea = $('#podsArea').empty();
  
  // Collect all players from all pods and sort by name
  const allPlayers = [];
  (res.pods||[]).forEach(pod=>{
    pod.seats.forEach(s=>{
      allPlayers.push({
        name: s.name,
        pod: pod.pod,
        seat: s.seat
      });
    });
  });
  allPlayers.sort((a,b) => a.name.localeCompare(b.name));
  
  // Create a table sorted by player name
  const card = $('<div class="card"/>');
  card.append($('<div/>').html('<strong>Players by Name</strong> ('+allPlayers.length+')'));
  
  const table = $('<table class="table"/>');
  const thead = $('<thead/>');
  const headerRow = $('<tr/>');
  headerRow.append($('<th/>').text('Player'));
  headerRow.append($('<th/>').text('Pod'));
  headerRow.append($('<th/>').text('Seat'));
  thead.append(headerRow);
  table.append(thead);
  
  const tbody = $('<tbody/>');
  allPlayers.forEach(p=>{
    const tr = $('<tr/>');
    tr.append($('<td/>').text(p.name));
    tr.append($('<td/>').text(p.pod));
    tr.append($('<td/>').text(p.seat));
    tbody.append(tr);
  });
  table.append(tbody);
  
  card.append(table);
  podsArea.append(card);

  // Top 8 Draft Visualization
  if(status === 'top8_draft') {
    const top8DraftVisuals = $('#top8DraftVisuals').empty();
    
    // Get top 8 players with their seats
    const top8Players = (res.players || [])
      .filter(p => p.top8_seat !== null)
      .sort((a, b) => a.top8_seat - b.top8_seat);
    
    if(top8Players.length > 0) {
      const draftCard = $('<div class="card"/>');
      draftCard.append($('<div/>').html('<strong>Top 8 Draft Seating</strong>'));
      
      const vis = $('<div/>').addClass('draft-table');
      
      // Create seat map for easy lookup
      const seatMap = {};
      top8Players.forEach(p => { seatMap[p.top8_seat] = p; });
      
      // For 8 players: show all 8 seats in a 4x2 grid
      const topRow = $('<div/>').addClass('draft-row');
      const bottomRow = $('<div/>').addClass('draft-row');
      
      // Top row: 1, 2, 3, 4
      [1, 2, 3, 4].forEach(seatNum => {
        const player = seatMap[seatNum];
        const seatDiv = $('<div/>').addClass('seat');
        seatDiv.append($('<span/>').addClass('pos').text('S'+seatNum));
        seatDiv.append($('<span/>').addClass('name').text(player ? player.name : ''));
        topRow.append(seatDiv);
      });
      
      // Bottom row: 8, 7, 6, 5 (reverse order)
      [8, 7, 6, 5].forEach(seatNum => {
        const player = seatMap[seatNum];
        const seatDiv = $('<div/>').addClass('seat');
        seatDiv.append($('<span/>').addClass('pos').text('S'+seatNum));
        seatDiv.append($('<span/>').addClass('name').text(player ? player.name : ''));
        bottomRow.append(seatDiv);
      });
      
      vis.append(topRow);
      vis.append(bottomRow);
      
      draftCard.append(vis);
      top8DraftVisuals.append(draftCard);
    }
  }

  // Pairings
  if(res.current_round){
    $('#pairingsCard').show(); $('#roundNo').text(getRoundLabel(res.current_round));
    initTabs(); // Initialize tab functionality
    if(res.standings && res.standings.length){ renderAdminRoundStandings(res.standings); }
    
    // Preserve input values before rebuilding table
    const preservedInputs = {};
    $('#pairingsTbl tbody tr').each(function() {
      const $row = $(this);
      const inputs = $row.find('input.result-input');
      if (inputs.length >= 3) {
        const p1Val = inputs.eq(0).val();
        const p2Val = inputs.eq(1).val();
        const drawsVal = inputs.eq(2).val();
        // Only preserve if at least one field has a value and no result is saved yet
        if ((p1Val || p2Val || drawsVal) && !$row.find('.result-input-container').hasClass('has-result')) {
          const matchId = $row.data('match-id');
          if (matchId) {
            preservedInputs[matchId] = { p1: p1Val, p2: p2Val, draws: drawsVal };
          }
        }
      }
    });
    
    const tb = $('#pairingsTbl tbody').empty();
    (res.matches||[]).forEach((m,idx)=>{
      const tr = $('<tr/>').data('match-id', m.id);
      tr.append($('<td/>').text(m.table_no || '-'));
      
      // Player 1 column
      tr.append($('<td/>').text(m.p1_name || '-'));
      
      // Score 1 column
      const score1Cell = $('<td/>');
      const score1Input = $('<input type="number" class="result-input" min="0" max="2" style="width:50px; background:#0f1318; border:1px solid #1f2a38; color:#e7edf4; padding:4px; border-radius:4px; text-align:center;" placeholder="0"/>');
      if(m.p1_game_wins != null) {
        score1Input.val(m.p1_game_wins);
      }
      if(m.confirmed) {
        // Make confirmed input disabled and greyed out (but still editable via Edit button)
        score1Input.prop('disabled', true).css('opacity', '0.6').css('background', '#1a1a1a').css('color', '#888');
      } else if(m.p1_game_wins != null || m.p2_game_wins != null || m.draws != null) {
        // Make saved but unconfirmed inputs appear disabled but editable on click
        score1Input.prop('disabled', true).css('opacity', '0.7').css('background', '#1a1a1a').css('color', '#999');
      }
      score1Cell.append(score1Input);
      tr.append(score1Cell);
      
      // VS column
      tr.append($('<td/>').text('VS'));
      
      // Player 2 column
      tr.append($('<td/>').text(m.p2_name || (m.is_bye?'(BYE)':'-')));
      
      // Score 2 column
      const score2Cell = $('<td/>');
      const score2Input = $('<input type="number" class="result-input" min="0" max="2" style="width:50px; background:#0f1318; border:1px solid #1f2a38; color:#e7edf4; padding:4px; border-radius:4px; text-align:center;" placeholder="0"/>');
      if(m.p2_game_wins != null) {
        score2Input.val(m.p2_game_wins);
      }
      if(m.confirmed) {
        // Make confirmed input disabled and greyed out (but still editable via Edit button)
        score2Input.prop('disabled', true).css('opacity', '0.6').css('background', '#1a1a1a').css('color', '#888');
      } else if(m.p1_game_wins != null || m.p2_game_wins != null || m.draws != null) {
        // Make saved but unconfirmed inputs appear disabled but editable on click
        score2Input.prop('disabled', true).css('opacity', '0.7').css('background', '#1a1a1a').css('color', '#999');
      }
      score2Cell.append(score2Input);
      tr.append(score2Cell);
      
      // Draws column
      const drawsCell = $('<td/>');
      const drawsInput = $('<input type="number" class="result-input" min="0" max="3" style="width:50px; background:#0f1318; border:1px solid #1f2a38; color:#e7edf4; padding:4px; border-radius:4px; text-align:center;" placeholder="0"/>');
      if(m.draws != null) {
        drawsInput.val(m.draws);
      }
      if(m.confirmed) {
        // Make confirmed input disabled and greyed out (but still editable via Edit button)
        drawsInput.prop('disabled', true).css('opacity', '0.6').css('background', '#1a1a1a').css('color', '#888');
      } else if(m.p1_game_wins != null || m.p2_game_wins != null || m.draws != null) {
        // Make saved but unconfirmed inputs appear disabled but editable on click
        drawsInput.prop('disabled', true).css('opacity', '0.7').css('background', '#1a1a1a').css('color', '#999');
      }
      drawsCell.append(drawsInput);
      tr.append(drawsCell);
      
      // Add save/edit button for all results
      const saveCell = $('<td/>');
      let saveBtn;
      
      if(m.p1_game_wins != null || m.p2_game_wins != null || m.draws != null) {
        // Show Edit button for saved results (confirmed or not)
        saveBtn = $('<button class="ghost small-btn"/>').text('Edit').on('click', function(){
          // Enable inputs for editing
          score1Input.prop('disabled', false).css('opacity', '1').css('background', '#0f1318').css('color', '#e7edf4');
          score2Input.prop('disabled', false).css('opacity', '1').css('background', '#0f1318').css('color', '#e7edf4');
          drawsInput.prop('disabled', false).css('opacity', '1').css('background', '#0f1318').css('color', '#e7edf4');
          
          // Change button to Save
          $(this).text('Save').off('click').on('click', function(){
            const p1Wins = parseInt(score1Input.val()) || 0;
            const p2Wins = parseInt(score2Input.val()) || 0;
            const draws = parseInt(drawsInput.val()) || 0;
            
            // Basic validation
            if (p1Wins < 0 || p1Wins > 2 || p2Wins < 0 || p2Wins > 2 || draws < 0 || draws > 3) {
              alert('Invalid result. Game wins must be between 0 and 2, draws between 0 and 3.');
              return;
            }
            
            api('admin_edit_result', {match_id: m.id, p1: p1Wins, p2: p2Wins, draws: draws}).done(load);
          });
        });
      } else {
        // Show Save button for new results
        saveBtn = $('<button class="ghost small-btn"/>').text('Save').on('click', function(){
          const p1Wins = parseInt(score1Input.val()) || 0;
          const p2Wins = parseInt(score2Input.val()) || 0;
          const draws = parseInt(drawsInput.val()) || 0;
          
          // Basic validation
          if (p1Wins < 0 || p1Wins > 2 || p2Wins < 0 || p2Wins > 2 || draws < 0 || draws > 3) {
            alert('Invalid result. Game wins must be between 0 and 2, draws between 0 and 3.');
            return;
          }
          
          api('admin_edit_result', {match_id: m.id, p1: p1Wins, p2: p2Wins, draws: draws}).done(load);
        });
      }
      
      saveCell.append(saveBtn);
      tr.append(saveCell);
      
      // Confirmed column
      const confirmedCell = $('<td/>');
      if(m.p1_game_wins!=null && m.p2_game_wins!=null){
        // Always show a checkbox for results that have been entered
        const checkbox = $('<input type="checkbox"/>').prop('checked', m.confirmed).on('change', function(){
          const $this = $(this);
          const newChecked = $this.prop('checked');
          api('admin_confirm_result', {match_id: m.id, confirmed: newChecked ? 1 : 0}).done(function(response) {
            if (response.ok) {
              // Success - update the checkbox state locally and let auto-refresh handle the rest
              $this.prop('checked', newChecked);
            } else {
              // Error - revert the checkbox state
              $this.prop('checked', !newChecked);
              alert('Error: ' + (response.error || 'Failed to update confirmation'));
            }
          }).fail(function() {
            // Network error - revert the checkbox state
            $this.prop('checked', !newChecked);
            alert('Network error: Failed to update confirmation');
          });
        });
        confirmedCell.append(checkbox);
      } else {
        // No result entered yet - show disabled/greyed out checkbox
        const checkbox = $('<input type="checkbox" disabled/>').prop('checked', false);
        confirmedCell.append(checkbox);
      }
      tr.append(confirmedCell);
      
      tb.append(tr);
    });

    $('#nextRoundBtn').off('click').on('click',()=> {
      // Check if all matches have results entered
      const matches = res.matches || [];
      const incompleteMatches = matches.filter(m => 
        !m.is_bye && (m.p1_game_wins == null || m.p2_game_wins == null)
      );
      
      if (incompleteMatches.length > 0) {
        alert('Please enter all match results before creating the next round.');
        return;
      }
      
      api('next_round',{}).done(load);
    });
    $('#finalizeBtn').off('click').on('click',()=> api('finalize_standings',{}).done(load));
    $('#createTop8Btn').off('click').on('click',()=> api('create_top8',{}).done(load));
    $('#startTop8Btn').off('click').on('click',()=> api('start_top8',{}).done(load));
    
    // Restore focused input if it was being edited
    if (focusedInputInfo) {
      const targetRow = $(`tr[data-match-id="${focusedInputInfo.matchId}"]`);
      if (targetRow.length > 0) {
        const inputs = targetRow.find('input.result-input');
        if (inputs.length > focusedInputInfo.inputType) {
          const targetInput = inputs.eq(focusedInputInfo.inputType);
          targetInput.val(focusedInputInfo.value);
          targetInput.focus();
          // Restore cursor position
          setTimeout(() => {
            targetInput[0].setSelectionRange(focusedInputInfo.cursorPosition, focusedInputInfo.cursorPosition);
          }, 10);
        }
      }
    }
  } else {
    $('#pairingsCard').hide();
  }

  // Standings
  if(res.standings && res.standings.length){
    if(status==='standings'){
      $('#standingsCard').show();
      const tb = $('#standingsTbl tbody').empty();
      res.standings.forEach((r,idx)=>{
        const tr = $('<tr/>');
        tr.append($('<td/>').text(idx+1));
        tr.append($('<td/>').text(r.name));
        tr.append($('<td/>').text(r.mp));
        tr.append($('<td/>').text(r.omw.toFixed(3)));
        tr.append($('<td/>').text(r.gwp.toFixed(3)));
        tr.append($('<td/>').text(r.ogw.toFixed(3)));
        tb.append(tr);
      });
    } else if(status==='complete'){
      $('#finalStandingsCard').show();
      const tb = $('#finalStandingsTbl tbody').empty();
      res.standings.forEach((r,idx)=>{
        const tr = $('<tr/>');
        tr.append($('<td/>').text(idx+1));
        tr.append($('<td/>').text(r.name));
        tr.append($('<td/>').text(r.mp));
        tr.append($('<td/>').text(r.omw.toFixed(3)));
        tr.append($('<td/>').text(r.gwp.toFixed(3)));
        tr.append($('<td/>').text(r.ogw.toFixed(3)));
        tb.append(tr);
      });
    }
  } else {
    $('#standingsCard').hide();
    $('#finalStandingsCard').hide();
  }

  // Show/hide stages based on status - only show one stage at a time
  $('#preparationStage').toggle(status==='pre');
  $('#checkinStage').toggle(status==='checkin');
  $('#podsStage').toggle(status==='pods');
  $('#pairingsCard').toggle(status==='round' || status==='top8');
  $('#standingsCard').toggle(status==='standings');
  $('#finalStandingsCard').toggle(status==='complete');
  $('#top8CreationCard').toggle(status==='standings');
  $('#top8DraftCard').toggle(status==='top8_draft');

  // Buttons based on status
  $('#startBtn').toggle(status==='pre');
  $('#podsBtn').toggle(status==='checkin');
  $('#r1Btn').toggle(status==='pods');
  
  // Show final standings button when it's the last round, otherwise show next round button
  const isLastRound = status==='round' && res.settings.current_round >= res.settings.total_rounds;
  $('#finalizeBtn').toggle(isLastRound);
  $('#nextRoundBtn').toggle((status==='round' || status==='top8') && !isLastRound);
  
  $('#createTop8Btn').toggle(status==='standings');

  // Debug
  $('#dbgPopulate').off('click').on('click',()=>{
    const n = parseInt($('#dbgCount').val()||'16',10);
    api('debug_populate',{n}).done(load);
  });
  $('#dbgCheckin').off('click').on('click',()=> api('debug_checkin_remaining',{}).done(load));
  $('#dbgRandom').off('click').on('click',()=> api('debug_randomize_results',{}).done(load));
}

// Debug toggle functionality
let debugMode = false;

function toggleDebugMode() {
  debugMode = !debugMode;
  const debugToggleBtn = $('#debugToggleBtn');
  
  if (debugMode) {
    debugToggleBtn.addClass('active');
    // Show debug elements by removing the class and making them visible
    $('#newEventBtn').removeClass('debug-hidden').show();
    $('#debugCard').removeClass('debug-hidden').show();
  } else {
    debugToggleBtn.removeClass('active');
    // Hide debug elements by adding the class and hiding them
    $('#newEventBtn').addClass('debug-hidden').hide();
    $('#debugCard').addClass('debug-hidden').hide();
  }
}

// Initialize debug toggle
$(document).ready(function() {
  $('#debugToggleBtn').off('click').on('click', toggleDebugMode);
  
  // Initialize debug mode as hidden
  debugMode = false;
  $('#newEventBtn').addClass('debug-hidden').hide();
  $('#debugCard').addClass('debug-hidden').hide();
});


setInterval(load, 3000);
load();

// Ensure debug toggle is properly initialized after page load
$(document).ready(function() {
  setTimeout(function() {
    $('#debugToggleBtn').off('click').on('click', toggleDebugMode);
    // Ensure debug elements start hidden
    if (!debugMode) {
      $('#newEventBtn').addClass('debug-hidden').hide();
      $('#debugCard').addClass('debug-hidden').hide();
    }
  }, 100);
});
</script>
</body>
</html>

