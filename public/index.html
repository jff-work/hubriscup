<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hubris Cup – Player</title>
  <link rel="stylesheet" href="/assets/css/style.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="/assets/js/i18n.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="container header">
      <div class="menu">
        <div id="playerInfo" class="pill" style="display:none; text-align: center;">
          <span id="currentPlayerName" style="font-size: 14px; font-weight: 600; color: var(--ink);"></span>
          <button class="secondary small-btn" id="menuChangePlayer"><span data-i18n="changePlayer"></span></button>
        </div>
        <label class="lang-toggle small">
          <span data-i18n="locale"></span>:
          <select id="langSel">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card center welcome-card">
      <div class="huge" id="welcome"></div>
      <div id="subWelcome" class="small"></div>
    </div>

    <div id="playerSelect" class="card" style="display:none">
      <div class="stack">
        <div><strong data-i18n="selectPlayer"></strong></div>
        <ul id="playersList" class="list"></ul>
      </div>
    </div>

    <div id="checkinCard" class="card" style="display:none">
      <div class="flex">
        <div><span class="badge green" id="whoAmI"></span></div>
      </div>
      <div class="center" style="margin-top:20px">
        <button id="checkinBtn" class="btn"><span data-i18n="checkinButton"></span></button>
      </div>
      <div class="small center" style="margin-top:15px" data-i18n="dropNote"></div>
    </div>

    <div id="seatCard" class="card" style="display:none">
      <div class="center" style="margin: 30px 0;"><div class="huge" id="seatText"></div></div>
      <div id="draftVis" class="draft-table"></div>
    </div>

    <div id="roundCard" class="card" style="display:none">
      <div class="flex">
        <div><strong><span data-i18n="currentRound"></span> <span id="roundNo">1</span></strong></div>
        <div class="right small"><a href="/admin" target="_blank">Admin</a></div>
      </div>
      <div class="grid two" style="margin-top:15px">
        <div class="card">
          <div><strong data-i18n="myTable"></strong>: <span id="myTable"></span></div>
          <div><strong data-i18n="opponent"></strong>: <span id="myOpp"></span></div>
        </div>
        <div class="card">
          <div class="stack">
            <label><span data-i18n="result"></span> (you – opp)</label>
            <div class="flex" style="margin-top:10px">
              <input type="number" id="gYou" min="0" max="3" value="2" style="width:80px">
              <span>:</span>
              <input type="number" id="gOpp" min="0" max="3" value="0" style="width:80px">
            </div>
            <div class="center" style="margin-top:15px">
              <button id="enterBtn" class="btn"><span data-i18n="enter"></span></button>
            </div>
            <div id="manualOnlyNote" class="small" style="display:none" data-i18n="manualOnly"></div>
            <div id="oppReported" class="small"></div>
          </div>
        </div>
      </div>
      <div class="small" style="margin-top:15px" data-i18n="dropNote"></div>
      <div class="legend" id="legendNoPhone" data-i18n="noPhoneExplain"></div>
    </div>

    <div id="standingsCard" class="card" style="display:none">
      <div class="flex">
        <strong data-i18n="standings"></strong>
      </div>
      <div style="overflow:auto">
        <table class="table" id="standingsTbl">
          <thead>
            <tr>
              <th>#</th>
              <th data-i18n="players"></th>
              <th data-i18n="points"></th>
              <th data-i18n="omw"></th>
              <th data-i18n="gwp"></th>
              <th data-i18n="ogw"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="waitingCard" class="card" style="display:none">
      <div class="center">
        <div class="huge" data-i18n="waitingForTournament"></div>
        <div class="small" style="margin-top:15px" data-i18n="tournamentNotStarted"></div>
      </div>
    </div>

  </div>

<script>
function applyI18N(){
  $('#welcome').text(I18N.t('welcome', {YEAR: new Date().getFullYear()}));
  $('[data-i18n]').each(function(){
    const k = $(this).data('i18n'); $(this).text(I18N.t(k));
  });
  $('#langSel').val(I18N.lang);
}
$('#langSel').on('change', function(){ I18N.setLang(this.value); applyI18N(); });
document.addEventListener('langchange', applyI18N);
applyI18N();

const api = (a, data) => $.ajax({url:'/api/api.php?a='+encodeURIComponent(a), method:'POST', data:data || {}, dataType:'json'});

let me = localStorage.getItem('player_id');

function ping(){ /* Online indicator removed from player view */ }

function loadState(){
  ping();
  api('get_state', {view:'player', me: me || ''}).done(res=>{
    renderState(res);
  });
}

function selectMe(id){
  me = String(id); localStorage.setItem('player_id', me);
  loadState();
}

function renderPlayerSelect(players){
  const ul = $('#playersList'); ul.empty();
  players.forEach(p=>{
    const li = $('<li/>');
    const left = $('<div/>').text(p.name);
    const right = $('<div/>');
    right.append($('<span/>').addClass('badge ' + (p.no_phone?'orange':(p.checked_in?'green':'')))
      .text(p.no_phone ? I18N.t('noPhone') : (p.checked_in ? I18N.t('checkedIn') : I18N.t('notCheckedIn'))));
    li.append(left).append(right);
    li.css('cursor','pointer').on('click', ()=> selectMe(p.id));
    ul.append(li);
  });
}

function renderSeat(pods, my){
  if(!my || my.pod==null){ $('#seatCard').hide(); return; }
  $('#seatCard').show();
  $('#seatText').text('Pod ' + my.pod + ' Seat ' + my.pod_seat);
  const pod = pods.find(x=>x.pod==my.pod);
  const seats = pod ? pod.seats : [];
  const vis = $('#draftVis'); vis.empty().addClass('draft-table');
  
  // Create seat map for easy lookup
  const seatMap = {};
  seats.forEach(s => { seatMap[s.seat] = s; });
  
  // Create left side (seats 1, 2, 3, 4 - top row)
  const leftSide = $('<div/>').addClass('draft-side');
  [1, 2, 3, 4].forEach(seatNum => {
    const seat = seatMap[seatNum];
    if(seat){
      const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
      seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
      seatDiv.append($('<span/>').addClass('name').text(seat.name));
      leftSide.append(seatDiv);
    }
  });
  
  // Create right side (seats 8, 7, 6, 5 - bottom row, reverse order)
  const rightSide = $('<div/>').addClass('draft-side');
  [8, 7, 6, 5].forEach(seatNum => {
    const seat = seatMap[seatNum];
    if(seat){
      const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
      seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
      seatDiv.append($('<span/>').addClass('name').text(seat.name));
      rightSide.append(seatDiv);
    }
  });
  
  // Assemble the table
  vis.append(leftSide);
  vis.append(rightSide);
}

function renderRound(my, round, match, oppReport){
  if(!my || !round){ $('#roundCard').hide(); return; }
  $('#roundCard').show();
  $('#roundNo').text(round);
  if(match){
    $('#myTable').text(match.table_no || '-');
    const opp = (match.p1_id==my.id)? match.p2_name : match.p1_name;
    $('#myOpp').text(opp || '-');
    if(oppReport){
      $('#oppReported').text('Opponent reported: '+oppReport.p1+'-'+oppReport.p2);
    } else {
      $('#oppReported').text('');
    }
    const isManual = !!my.no_phone;
    $('#enterBtn').prop('disabled', isManual);
    $('#manualOnlyNote').toggle(isManual);
    $('#enterBtn').off('click').on('click', ()=>{
      if(isManual) return;
      const gy = parseInt($('#gYou').val()||'0',10);
      const go = parseInt($('#gOpp').val()||'0',10);
      api('submit_result', {match_id: match.id, reporter_id: my.id, g_you: gy, g_opp: go}).done(loadState);
    });
  } else {
    $('#myTable').text('-'); $('#myOpp').text('-'); $('#oppReported').text('');
  }
}

function renderStandings(stand){
  const tb = $('#standingsTbl tbody'); tb.empty();
  (stand || []).forEach((r,idx)=>{
    const tr = $('<tr/>');
    tr.append($('<td/>').text(idx+1));
    tr.append($('<td/>').text(r.name));
    tr.append($('<td/>').text(r.mp));
    tr.append($('<td/>').text(r.omw.toFixed(3)));
    tr.append($('<td/>').text(r.gwp.toFixed(3)));
    tr.append($('<td/>').text(r.ogw.toFixed(3)));
    tb.append(tr);
  });
}

function renderState(res){
  $('#welcome').text(I18N.t('welcome', {YEAR: res.year}));

  const st = res.settings;
  const status = st.status;
  const players = res.players || [];
  const pods = res.pods || [];
  const my = me ? players.find(p=> String(p.id)===String(me)) : null;

  // Top menu change-player always
  $('#menuChangePlayer').off('click').on('click', ()=>{ localStorage.removeItem('player_id'); me=null; loadState(); });

  function showOnly(ids){
    const all = ['.welcome-card','#playerSelect','#checkinCard','#seatCard','#roundCard','#standingsCard','#waitingCard'];
    all.forEach(id=> $(id).hide());
    ids.forEach(id=> $(id).show());
  }

  if(!my){
    $('#playerInfo').hide();
    renderPlayerSelect(players);
    showOnly(['.welcome-card', '#playerSelect']);
    return;
  }

  $('#currentPlayerName').text(my.name);
  $('#playerInfo').show();
  $('#whoAmI').text(my.name);
  renderSeat(pods, my);

  // Strict flow control: Preparation → Check-in → Pods → Rounds → Standings → Top 8
  if(status==='pre'){
    // Preparation stage: show waiting message if player is selected, otherwise show player selection
    if(my){
      showOnly(['.welcome-card', '#waitingCard']);
    } else {
      showOnly(['.welcome-card', '#playerSelect']);
    }
  } else if(status==='checkin'){
    // Check-in stage: show check-in interface
    if(!my.checked_in){
      showOnly(['#checkinCard']);
      $('#checkinBtn').prop('disabled', false).removeClass('green').text(I18N.t('checkinButton')).off('click').on('click', ()=> api('check_in', {player_id: my.id, checked:1}).done(loadState));
    } else {
      showOnly(['#checkinCard']);
      $('#checkinBtn').prop('disabled', true).text(I18N.t('checkedIn')).addClass('green');
    }
  } else if(status==='pods'){
    // Pods stage: show draft seat information
    showOnly(['#seatCard']);
  } else if(status==='round'){
    // Round stage: show current round match
    const match = res.my_match || null;
    renderRound(my, res.current_round, match, res.opp_report);
    showOnly(['#roundCard']);
  } else if(status==='top8'){
    // Top 8 stage: show Top 8 matches
    const match = res.my_match || null;
    renderRound(my, res.current_round, match, res.opp_report);
    showOnly(['#roundCard']);
  } else if(status==='standings' || status==='complete'){
    // Standings stage: show final standings
    showOnly(['#standingsCard']);
  } else {
    // Fallback: show player selection
    showOnly(['#playerSelect']);
  }

  if(res.standings && res.standings.length){ $('#standingsCard').show(); renderStandings(res.standings); }
}

setInterval(loadState, 3000);
loadState();
</script>
</body>
</html>
