<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Hubris Cup – Player</title>
  <link rel="stylesheet" href="/assets/css/style.css">
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="/assets/js/i18n.js"></script>
</head>
<body>
  <div class="topbar">
    <div class="container header">
      <div class="menu">
        <div id="playerInfo" class="pill" style="display:none; text-align: center;">
          <span id="currentPlayerName" style="font-size: 14px; font-weight: 600; color: var(--ink);"></span>
          <button class="secondary small-btn" id="menuChangePlayer"><span data-i18n="changePlayer"></span></button>
        </div>
        <label class="lang-toggle small">
          <span data-i18n="locale"></span>:
          <select id="langSel">
            <option value="de">Deutsch</option>
            <option value="en">English</option>
          </select>
        </label>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="card center welcome-card">
      <div class="huge" id="welcome"></div>
      <div id="subWelcome" class="small"></div>
    </div>

    <div id="playerSelect" class="card" style="display:none">
      <div class="stack">
        <div><strong data-i18n="selectPlayer"></strong></div>
        <ul id="playersList" class="list"></ul>
      </div>
    </div>

    <div id="checkinCard" class="card" style="display:none">
      <div class="flex">
        <div><span class="badge green" id="whoAmI"></span></div>
      </div>
      <div class="center" style="margin-top:20px">
        <button id="checkinBtn" class="btn"><span data-i18n="checkinButton"></span></button>
      </div>
      <div class="small center" style="margin-top:15px" data-i18n="dropNote"></div>
      <div class="small center" style="margin-top:10px; color: #666;">
        If your name is not listed, please contact the TO
      </div>
    </div>

    <div id="seatCard" class="card" style="display:none">
      <div class="center" style="margin: 30px 0;"><div class="huge" id="seatText"></div></div>
      <div id="draftVis" class="draft-table"></div>
    </div>

    <div id="roundCard" class="card" style="display:none">
      <!-- Single row tab layout: Round 1 (non-clickable) + Match + Standings -->
      <div class="tab-nav" style="margin-top:0; margin-bottom:15px;">
        <div class="tab-btn round-tab" style="background:var(--card); color:var(--ink); cursor:default; border-bottom:2px solid var(--accent);">
          <strong><span data-i18n="currentRound"></span> <span id="roundNo">1</span></strong>
        </div>
        <button class="tab-btn active" data-tab="match">Match</button>
        <button class="tab-btn" data-tab="standings">Standings</button>
      </div>
      
      <!-- Match Tab Content -->
      <div id="matchTab" class="tab-content active">
        <!-- Match Info Display -->
        <div class="match-info-display" style="margin: 30px 0; text-align: center;">
          <div class="match-detail">
            <div class="match-label" data-i18n="myTable"></div>
            <div class="match-value huge" id="myTable">-</div>
          </div>
          <div class="match-detail">
            <div class="match-label" data-i18n="opponent"></div>
            <div class="match-value huge" id="myOpp">-</div>
          </div>
        </div>
        
        <!-- Result Entry -->
        <div class="result-entry-container">
          <div class="result-entry-card">
            <div id="opponentReportedMessage" class="opponent-reported-message" style="display:none">
              <span id="opponentName"></span> reported <span id="opponentResult"></span>
            </div>
            <div class="result-labels">
              <div class="result-label">You</div>
              <div class="result-label">Opponent</div>
              <div class="result-label">Draws</div>
            </div>
            <div class="result-inputs">
              <input type="number" id="gYou" min="0" max="2" value="2" class="result-input">
              <span class="result-separator">:</span>
              <input type="number" id="gOpp" min="0" max="2" value="0" class="result-input">
              <span class="result-separator">:</span>
              <input type="number" id="gDraws" min="0" max="3" value="0" class="result-input">
            </div>
            <div class="result-actions">
              <button id="confirmBtn" class="btn result-btn confirm-btn" style="display:none">Confirm Result</button>
              <button id="enterBtn" class="btn result-btn"><span data-i18n="enter"></span></button>
              <button id="changeBtn" class="btn secondary result-btn" style="display:none">Change Result</button>
            </div>
            <div id="waitingMessage" class="waiting-message" style="display:none">
              Waiting for opponent to confirm
            </div>
            <div id="resultConfirmed" class="result-confirmed" style="display:none">
              <span class="badge green">Result Confirmed</span>
              <div class="small" style="margin-top:10px; color: #666;">
                Please contact TO if something is wrong
              </div>
            </div>
            <div id="manualOnlyNote" class="small" style="display:none" data-i18n="manualOnly"></div>
          </div>
        </div>
        <div class="small center" style="margin-top:15px" data-i18n="dropNote"></div>
      </div>
      
      <!-- Standings Tab Content -->
      <div id="standingsTab" class="tab-content">
        <div style="overflow:auto; margin-top:15px">
          <table class="table" id="roundStandingsTbl">
            <thead>
              <tr>
                <th>#</th>
                <th data-i18n="players"></th>
                <th data-i18n="points"></th>
                <th data-i18n="omw"></th>
                <th data-i18n="gwp"></th>
                <th data-i18n="ogw"></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="standingsCard" class="card" style="display:none">
      <div class="flex">
        <strong data-i18n="standings"></strong>
      </div>
      <div style="overflow:auto">
        <table class="table" id="standingsTbl">
          <thead>
            <tr>
              <th>#</th>
              <th data-i18n="players"></th>
              <th data-i18n="points"></th>
              <th data-i18n="omw"></th>
              <th data-i18n="gwp"></th>
              <th data-i18n="ogw"></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div id="waitingCard" class="card" style="display:none">
      <div class="center">
        <div class="huge" data-i18n="waitingForTournament"></div>
        <div class="small" style="margin-top:15px" data-i18n="tournamentNotStarted"></div>
      </div>
    </div>

  </div>

<script>
function applyI18N(){
  $('#welcome').text(I18N.t('welcome', {YEAR: new Date().getFullYear()}));
  $('[data-i18n]').each(function(){
    const k = $(this).data('i18n'); $(this).text(I18N.t(k));
  });
  $('#langSel').val(I18N.lang);
}
$('#langSel').on('change', function(){ I18N.setLang(this.value); applyI18N(); });
document.addEventListener('langchange', applyI18N);
applyI18N();

const api = (a, data) => $.ajax({
  url:'/api/api.php?a='+encodeURIComponent(a), 
  method:'POST', 
  data:data || {}, 
  dataType:'json',
  cache: false,
  headers: {
    'Cache-Control': 'no-cache, no-store, must-revalidate',
    'Pragma': 'no-cache',
    'Expires': '0'
  }
});

let me = localStorage.getItem('player_id');

function ping(){ /* Online indicator removed from player view */ }

function loadState(){
  ping();
  // Add timestamp to prevent caching when switching players
  const cacheBuster = Date.now();
  console.log('Loading state for player:', me, 'at', new Date().toISOString());
  api('get_state', {view:'player', me: me || '', _t: cacheBuster}).done(res=>{
    console.log('Received state for player:', me, 'match_state:', res.match_state);
    renderState(res);
  });
}

function selectMe(id){
  console.log('Switching to player:', id, 'from player:', me);
  me = String(id); localStorage.setItem('player_id', me);
  // Force hard reload to ensure fresh data from database
  window.location.reload(true);
}

function renderPlayerSelect(players){
  const ul = $('#playersList'); ul.empty();
  players.forEach(p=>{
    const li = $('<li/>');
    const left = $('<div/>').text(p.name);
    const right = $('<div/>');
    right.append($('<span/>').addClass('badge ' + (p.no_phone?'orange':(p.checked_in?'green':'')))
      .text(p.no_phone ? I18N.t('noPhone') : (p.checked_in ? I18N.t('checkedIn') : I18N.t('notCheckedIn'))));
    li.append(left).append(right);
    li.css('cursor','pointer').on('click', ()=> selectMe(p.id));
    ul.append(li);
  });
}

function renderSeat(pods, my){
  if(!my || my.pod==null){ $('#seatCard').hide(); return; }
  $('#seatCard').show();
  $('#seatText').text('Pod ' + my.pod + ' Seat ' + my.pod_seat);
  const pod = pods.find(x=>x.pod==my.pod);
  const seats = pod ? pod.seats : [];
  const vis = $('#draftVis'); vis.empty().addClass('draft-table');
  
  // Create seat map for easy lookup
  const seatMap = {};
  seats.forEach(s => { seatMap[s.seat] = s; });
  
  const playerCount = seats.length;
  
  // Debug: log the player's seat info
  console.log('Player seat info:', { pod_seat: my.pod_seat, playerCount, seats: seats.map(s => ({ seat: s.seat, name: s.name })) });
  
  if (playerCount === 6) {
    // For 6 players: 3 seats on left, 3 seats on right
    const leftSide = $('<div/>').addClass('draft-side');
    const rightSide = $('<div/>').addClass('draft-side');
    
    // Left side: 1, 2, 3
    [1, 2, 3].forEach(seatNum => {
      const seat = seatMap[seatNum];
      if(seat){
        const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        leftSide.append(seatDiv);
      }
    });
    
    // Right side: 6, 5, 4 (reverse order)
    [6, 5, 4].forEach(seatNum => {
      const seat = seatMap[seatNum];
      if(seat){
        const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        rightSide.append(seatDiv);
      }
    });
    
    vis.append(leftSide);
    vis.append(rightSide);
  } else if (playerCount === 7) {
    // For 7 players: show only occupied seats but maintain 8-seat positioning
    const leftSide = $('<div/>').addClass('draft-side');
    const rightSide = $('<div/>').addClass('draft-side');
    
    // Left side: 1, 2, 3, 4 - only show occupied seats
    [1, 2, 3, 4].forEach(seatNum => {
      const seat = seatMap[seatNum];
      if(seat){
        const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        leftSide.append(seatDiv);
      } else {
        // Add invisible placeholder to maintain positioning
        const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
        leftSide.append(placeholder);
      }
    });
    
    // Right side: 8, 7, 6, 5 (reverse order) - only show occupied seats
    [8, 7, 6, 5].forEach(seatNum => {
      const seat = seatMap[seatNum];
      if(seat){
        const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        rightSide.append(seatDiv);
      } else {
        // Add invisible placeholder to maintain positioning
        const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
        rightSide.append(placeholder);
      }
    });
    
    vis.append(leftSide);
    vis.append(rightSide);
  } else if (playerCount === 8) {
    // For 8 players: show all 8 seats
    const leftSide = $('<div/>').addClass('draft-side');
    const rightSide = $('<div/>').addClass('draft-side');
    
    // Left side: 1, 2, 3, 4
    [1, 2, 3, 4].forEach(seatNum => {
      const seat = seatMap[seatNum];
      const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
      seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
      seatDiv.append($('<span/>').addClass('name').text(seat.name));
      leftSide.append(seatDiv);
    });
    
    // Right side: 8, 7, 6, 5 (reverse order)
    [8, 7, 6, 5].forEach(seatNum => {
      const seat = seatMap[seatNum];
      const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
      seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
      seatDiv.append($('<span/>').addClass('name').text(seat.name));
      rightSide.append(seatDiv);
    });
    
    vis.append(leftSide);
    vis.append(rightSide);
  } else if (playerCount === 9) {
    // For 9 players: show only occupied seats but maintain 10-seat positioning
    const leftSide = $('<div/>').addClass('draft-side');
    const rightSide = $('<div/>').addClass('draft-side');
    
    // Left side: 1, 2, 3, 4, 5 - only show occupied seats
    [1, 2, 3, 4, 5].forEach(seatNum => {
      const seat = seatMap[seatNum];
      if(seat){
        const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        leftSide.append(seatDiv);
      } else {
        // Add invisible placeholder to maintain positioning
        const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
        leftSide.append(placeholder);
      }
    });
    
    // Right side: 10, 9, 8, 7, 6 (reverse order) - only show occupied seats
    [10, 9, 8, 7, 6].forEach(seatNum => {
      const seat = seatMap[seatNum];
      if(seat){
        const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        rightSide.append(seatDiv);
      } else {
        // Add invisible placeholder to maintain positioning
        const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
        rightSide.append(placeholder);
      }
    });
    
    vis.append(leftSide);
    vis.append(rightSide);
  } else if (playerCount === 10) {
    // For 10 players: show all 10 seats
    const leftSide = $('<div/>').addClass('draft-side');
    const rightSide = $('<div/>').addClass('draft-side');
    
    // Left side: 1, 2, 3, 4, 5
    [1, 2, 3, 4, 5].forEach(seatNum => {
      const seat = seatMap[seatNum];
      const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
      seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
      seatDiv.append($('<span/>').addClass('name').text(seat.name));
      leftSide.append(seatDiv);
    });
    
    // Right side: 10, 9, 8, 7, 6 (reverse order)
    [10, 9, 8, 7, 6].forEach(seatNum => {
      const seat = seatMap[seatNum];
      const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
      seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
      seatDiv.append($('<span/>').addClass('name').text(seat.name));
      rightSide.append(seatDiv);
    });
    
    vis.append(leftSide);
    vis.append(rightSide);
  } else {
    // For other player counts: show only occupied seats but maintain appropriate positioning for odd counts
    const leftSide = $('<div/>').addClass('draft-side');
    const rightSide = $('<div/>').addClass('draft-side');
    
    // Determine if we need to maintain positioning (for odd player counts)
    const isOddCount = playerCount % 2 === 1;
    const maxSeats = Math.max(...seats.map(s => s.seat));
    
    // For odd counts, determine the appropriate layout based on max seats
    const useTenSeatLayout = isOddCount && maxSeats > 8;
    const leftSeats = useTenSeatLayout ? [1, 2, 3, 4, 5] : [1, 2, 3, 4];
    const rightSeats = useTenSeatLayout ? [10, 9, 8, 7, 6] : [8, 7, 6, 5];
    
    // Left side: show occupied or placeholder for odd counts
    leftSeats.forEach(seatNum => {
      const seat = seatMap[seatNum];
      if(seat){
        const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        leftSide.append(seatDiv);
      } else if (isOddCount && seatNum <= maxSeats) {
        // Add invisible placeholder to maintain positioning for odd counts
        const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
        leftSide.append(placeholder);
      }
    });
    
    // Right side: show occupied or placeholder for odd counts
    rightSeats.forEach(seatNum => {
      const seat = seatMap[seatNum];
      if(seat){
        const seatDiv = $('<div/>').addClass('seat').toggleClass('me', seat.seat==my.pod_seat);
        seatDiv.append($('<span/>').addClass('pos').text('S'+seat.seat));
        seatDiv.append($('<span/>').addClass('name').text(seat.name));
        rightSide.append(seatDiv);
      } else if (isOddCount && seatNum <= maxSeats) {
        // Add invisible placeholder to maintain positioning for odd counts
        const placeholder = $('<div/>').addClass('seat').css('visibility', 'hidden');
        rightSide.append(placeholder);
      }
    });
    
    vis.append(leftSide);
    vis.append(rightSide);
  }
}

function renderRound(my, round, match, matchState, oppReport){
  if(!my || !round){ $('#roundCard').hide(); return; }
  $('#roundCard').show();
  $('#roundNo').text(round);
  if(match){
    $('#myTable').text(match.table_no || '-');
    const opp = match.is_bye ? 'Bye' : ((match.p1_id==my.id)? match.p2_name : match.p1_name);
    $('#myOpp').text(opp || '-');
    
    const isManual = !!my.no_phone;
    $('#enterBtn').prop('disabled', isManual);
    $('#manualOnlyNote').toggle(isManual);
    
    // Reset all UI elements first
    $('#confirmBtn').hide();
    $('#enterBtn').hide();
    $('#changeBtn').hide();
    $('#waitingMessage').hide();
    $('#resultConfirmed').hide();
    $('#opponentReportedMessage').hide();
    $('#gYou, #gOpp').prop('disabled', false);
    
    if (matchState && matchState.confirmed) {
      // Result is confirmed - show final state
      $('#resultConfirmed').show();
      $('#gYou, #gOpp, #gDraws').prop('disabled', true);
    } else if (matchState && matchState.opponent_reported && !matchState.i_reported) {
      // Opponent reported but I haven't - show confirm dialog
      $('#opponentReportedMessage').show();
      $('#opponentName').text(oppReport.opponent_name || 'Unknown');
      $('#opponentResult').text(oppReport.opponent_original || '0-0-0');
      $('#gYou').val(oppReport.you || 0).prop('disabled', true);
      $('#gOpp').val(oppReport.opp || 0).prop('disabled', true);
      $('#gDraws').val(oppReport.draws || 0).prop('disabled', true);
      $('#confirmBtn').show();
    } else if (matchState && matchState.i_reported && matchState.opponent_reported) {
      // Both players have reported, show opponent's result for confirmation
      $('#opponentReportedMessage').show();
      $('#opponentName').text(oppReport.opponent_name || 'Unknown');
      $('#opponentResult').text(oppReport.opponent_original || '0-0-0');
      $('#gYou').val(oppReport.you || 0).prop('disabled', true);
      $('#gOpp').val(oppReport.opp || 0).prop('disabled', true);
      $('#gDraws').val(oppReport.draws || 0).prop('disabled', true);
      $('#confirmBtn').show();
      $('#changeBtn').show(); // I can change my result
    } else if (matchState && matchState.i_reported) {
      // I reported, waiting for opponent
      $('#waitingMessage').show();
      $('#gYou, #gOpp, #gDraws').prop('disabled', true);
      $('#changeBtn').show(); // I can change my result
    } else {
      // No one has reported yet - show entry form
      $('#enterBtn').show();
      $('#gYou, #gOpp, #gDraws').prop('disabled', false);
    }
    
    // Enter button handler (for initial report)
    $('#enterBtn').off('click').on('click', ()=>{
      if(isManual) return;
      
      const gy = parseInt($('#gYou').val()||'0',10);
      const go = parseInt($('#gOpp').val()||'0',10);
      const gd = parseInt($('#gDraws').val()||'0',10);
      
      // Validate result - must have at least 1 game and total games must be reasonable
      const totalGames = gy + go + gd;
      if (totalGames < 1 || totalGames > 5) {
        alert('Invalid result. Total games must be between 1 and 5.');
        return;
      }
      
      if (gy < 0 || gy > 2 || go < 0 || go > 2 || gd < 0 || gd > 3) {
        alert('Invalid result. Game wins must be between 0 and 2, draws between 0 and 3.');
        return;
      }
      
      api('submit_result', {match_id: match.id, reporter_id: my.id, g_you: gy, g_opp: go, g_draws: gd}).done(()=>{
        loadState();
      }).fail(()=>{
        alert('Failed to submit result. Please try again.');
      });
    });
    
    // Confirm button handler
    $('#confirmBtn').off('click').on('click', ()=>{
      if(isManual) return;
      
      api('confirm_result', {match_id: match.id, confirmer_id: my.id}).done(()=>{
        loadState();
      }).fail(()=>{
        alert('Failed to confirm result. Please try again.');
      });
    });
    
    // Change button handler
    $('#changeBtn').off('click').on('click', ()=>{
      if(isManual) return;
      
      // Reset to entry mode
      $('#gYou, #gOpp, #gDraws').prop('disabled', false);
      $('#gYou').val('2');
      $('#gOpp').val('0');
      $('#enterBtn').show();
      $('#confirmBtn').hide();
      $('#changeBtn').hide();
      $('#waitingMessage').hide();
      $('#opponentReportedMessage').hide();
    });
  } else {
    $('#myTable').text('-'); 
    $('#myOpp').text('-');
    // Reset form state
    $('#gYou, #gOpp').prop('disabled', false);
    $('#gYou').val('2');
    $('#gOpp').val('0');
    $('#enterBtn').show();
    $('#confirmBtn').hide();
    $('#changeBtn').hide();
    $('#waitingMessage').hide();
    $('#resultConfirmed').hide();
    $('#opponentReportedMessage').hide();
  }
}

function renderStandings(stand){
  const tb = $('#standingsTbl tbody'); tb.empty();
  (stand || []).forEach((r,idx)=>{
    const tr = $('<tr/>');
    tr.append($('<td/>').text(idx+1));
    tr.append($('<td/>').text(r.name));
    tr.append($('<td/>').text(r.mp));
    tr.append($('<td/>').text(r.omw.toFixed(3)));
    tr.append($('<td/>').text(r.gwp.toFixed(3)));
    tr.append($('<td/>').text(r.ogw.toFixed(3)));
    tb.append(tr);
  });
}

function renderRoundStandings(stand){
  const tb = $('#roundStandingsTbl tbody'); tb.empty();
  (stand || []).forEach((r,idx)=>{
    const tr = $('<tr/>');
    tr.append($('<td/>').text(idx+1));
    tr.append($('<td/>').text(r.name));
    tr.append($('<td/>').text(r.mp));
    tr.append($('<td/>').text(r.omw.toFixed(3)));
    tr.append($('<td/>').text(r.gwp.toFixed(3)));
    tr.append($('<td/>').text(r.ogw.toFixed(3)));
    tb.append(tr);
  });
}

function initTabs(){
  $('.tab-btn').off('click').on('click', function(){
    const tabName = $(this).data('tab');
    
    // Remove active class from all tabs and content
    $('.tab-btn').removeClass('active');
    $('.tab-content').removeClass('active');
    
    // Add active class to clicked tab and corresponding content
    $(this).addClass('active');
    $('#' + tabName + 'Tab').addClass('active');
  });
}

function renderState(res){
  $('#welcome').text(I18N.t('welcome', {YEAR: res.year}));

  const st = res.settings;
  const status = st.status;
  const players = res.players || [];
  const pods = res.pods || [];
  const my = me ? players.find(p=> String(p.id)===String(me)) : null;

  // Top menu change-player always
  $('#menuChangePlayer').off('click').on('click', ()=>{ localStorage.removeItem('player_id'); me=null; loadState(); });

  function showOnly(ids){
    const all = ['.welcome-card','#playerSelect','#checkinCard','#seatCard','#roundCard','#standingsCard','#waitingCard'];
    all.forEach(id=> $(id).hide());
    ids.forEach(id=> $(id).show());
  }

  if(!my){
    $('#playerInfo').hide();
    renderPlayerSelect(players);
    showOnly(['.welcome-card', '#playerSelect']);
    return;
  }

  $('#currentPlayerName').text(my.name);
  $('#playerInfo').show();
  $('#whoAmI').text(my.name);
  renderSeat(pods, my);

  // Strict flow control: Preparation → Check-in → Pods → Rounds → Standings → Top 8
  if(status==='pre'){
    // Preparation stage: show only welcome card and player selection (no check-in until tournament starts)
    if(my){
      showOnly(['.welcome-card']);
    } else {
      showOnly(['.welcome-card', '#playerSelect']);
    }
  } else if(status==='checkin'){
    // Check-in stage: show check-in interface
    if(!my.checked_in){
      showOnly(['#checkinCard']);
      $('#checkinBtn').prop('disabled', false).removeClass('green').text(I18N.t('checkinButton')).off('click').on('click', ()=> api('check_in', {player_id: my.id, checked:1}).done(loadState));
    } else {
      showOnly(['#checkinCard']);
      $('#checkinBtn').prop('disabled', true).text(I18N.t('checkedIn')).addClass('green');
    }
  } else if(status==='pods'){
    // Pods stage: show draft seat information
    showOnly(['#seatCard']);
  } else if(status==='round'){
    // Round stage: show current round match
    const match = res.my_match || null;
    renderRound(my, res.current_round, match, res.match_state, res.opp_report);
    showOnly(['#roundCard']);
    initTabs(); // Initialize tab functionality
    if(res.standings && res.standings.length){ renderRoundStandings(res.standings); }
  } else if(status==='top8'){
    // Top 8 stage: show Top 8 matches
    const match = res.my_match || null;
    renderRound(my, res.current_round, match, res.match_state, res.opp_report);
    showOnly(['#roundCard']);
    initTabs(); // Initialize tab functionality
    if(res.standings && res.standings.length){ renderRoundStandings(res.standings); }
  } else if(status==='standings' || status==='complete'){
    // Standings stage: show final standings
    showOnly(['#standingsCard']);
  } else {
    // Fallback: show player selection
    showOnly(['#playerSelect']);
  }

  // Only show standalone standings card for final standings stage, not during rounds
  if((status==='standings' || status==='complete') && res.standings && res.standings.length){ 
    $('#standingsCard').show(); 
    renderStandings(res.standings); 
  }
}

setInterval(loadState, 3000);
loadState();
</script>
</body>
</html>
